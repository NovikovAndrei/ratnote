{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Редактировать тренировку</h2>
    <a class="btn btn-outline-secondary" href="/hattorihanzo?date={{ session.date|date:'Y-m-d' }}">Назад</a>
  </div>

  <div class="card p-3">
    <form method="post" id="session-edit-form">
      {% csrf_token %}

      <div class="row g-3 mb-3">
        <div class="col-md-3">{{ session_form.date.label_tag }}{{ session_form.date }}</div>
        <div class="col-md-3">{{ session_form.start_time.label_tag }}{{ session_form.start_time }}</div>
        <div class="col-md-3">{{ session_form.end_time.label_tag }}{{ session_form.end_time }}</div>
        <div class="col-md-3">{{ session_form.notes.label_tag }}{{ session_form.notes }}</div>
      </div>

      {% if session_form.non_field_errors %}
        <div class="text-danger mb-2">{{ session_form.non_field_errors }}</div>
      {% endif %}

      <div class="d-flex align-items-center justify-content-between mt-3">
        <div>
          <h6 class="mb-0">Упражнения</h6>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-primary" id="add-row-btn">+ Добавить ещё строку</button>
          <span id="reorder-status" class="small text-muted align-self-center"></span>
        </div>
      </div>

      {{ formset.management_form }}

      {# ===================== DESKTOP TABLE ===================== #}
      <div class="table-responsive mt-2 d-none d-md-block">
        <table class="table table-sm table-striped align-middle">
          <thead>
            <tr>
              <th style="width:48px;"></th>
              <th style="min-width:200px;">Упражнение</th>
              <th style="width:110px;">План</th>
              <th style="width:110px;">Факт</th>
              <th style="min-width:220px;">Плюсы</th>
              <th style="min-width:220px;">Минусы</th>
              <th style="width:120px;">Действие</th>
            </tr>
          </thead>

          <tbody id="formset-body-table">
            {% for f in formset %}
              <tr class="formset-row"
                  {% if f.instance.pk %}data-ex-id="{{ f.instance.pk }}"{% endif %}
                  draggable="true">
                <td class="text-center" style="cursor:grab; user-select:none;">≡</td>

                <td>
                  {{ f.id }}
                  <span style="display:none;">{{ f.DELETE }}</span>

                  {{ f.exercise }}
                  {% for err in f.exercise.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                </td>

                <td>
                  {{ f.planned_reps }}
                  {% for err in f.planned_reps.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                </td>

                <td>
                  {{ f.actual_reps }}
                  {% for err in f.actual_reps.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                </td>

                <td>{{ f.pros }}</td>
                <td>{{ f.cons }}</td>

                <td class="text-center">
                  {% if f.instance.pk %}
                    <button type="button"
                            class="btn btn-sm btn-outline-danger js-delete-saved"
                            data-delete-url="{% url 'hattorihanzo_exercise_delete' f.instance.pk %}">
                      Удалить
                    </button>
                  {% else %}
                    <button type="button" class="btn btn-sm btn-outline-danger js-remove-new">Удалить</button>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# ===================== MOBILE CARDS ===================== #}
      <div class="mt-2 d-block d-md-none" id="formset-cards">
        {% for f in formset %}
          <div class="card p-3 mb-2 formset-card"
               {% if f.instance.pk %}data-ex-id="{{ f.instance.pk }}"{% endif %}
               draggable="true">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="d-flex align-items-center gap-2">
                <div style="cursor:grab; user-select:none;">≡</div>
                <div class="fw-semibold">Упражнение</div>
              </div>

              {% if f.instance.pk %}
                <button type="button"
                        class="btn btn-sm btn-outline-danger js-delete-saved"
                        data-delete-url="{% url 'hattorihanzo_exercise_delete' f.instance.pk %}">
                  Удалить
                </button>
              {% else %}
                <button type="button" class="btn btn-sm btn-outline-danger js-remove-new">Удалить</button>
              {% endif %}
            </div>

            <div class="mb-2">
              {{ f.id }}
              <span style="display:none;">{{ f.DELETE }}</span>
              {{ f.exercise }}
              {% for err in f.exercise.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <div class="small text-muted mb-1">План</div>
                {{ f.planned_reps }}
                {% for err in f.planned_reps.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
              </div>
              <div class="col-6">
                <div class="small text-muted mb-1">Факт</div>
                {{ f.actual_reps }}
                {% for err in f.actual_reps.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
              </div>
            </div>

            <div class="mb-2">
              <div class="small text-muted mb-1">Плюсы</div>
              {{ f.pros }}
            </div>

            <div class="mb-0">
              <div class="small text-muted mb-1">Минусы</div>
              {{ f.cons }}
            </div>
          </div>
        {% endfor %}
      </div>

      {% if formset.non_form_errors %}
        <div class="text-danger mb-2">{{ formset.non_form_errors }}</div>
      {% endif %}

      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-primary" type="submit">Сохранить</button>
        <a class="btn btn-outline-danger" href="{% url 'hattorihanzo_session_delete' session.id %}">Удалить тренировку</a>
      </div>

      {# templates for new rows (table + card), use __prefix__ #}
      <template id="row-template-table">
        <tr class="formset-row" draggable="true">
          <td class="text-center" style="cursor:grab; user-select:none;">≡</td>
          <td>
            {{ formset.empty_form.id }}
            <span style="display:none;">{{ formset.empty_form.DELETE }}</span>
            {{ formset.empty_form.exercise }}
          </td>
          <td>{{ formset.empty_form.planned_reps }}</td>
          <td>{{ formset.empty_form.actual_reps }}</td>
          <td>{{ formset.empty_form.pros }}</td>
          <td>{{ formset.empty_form.cons }}</td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger js-remove-new">Удалить</button>
          </td>
        </tr>
      </template>

      <template id="row-template-card">
        <div class="card p-3 mb-2 formset-card" draggable="true">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="d-flex align-items-center gap-2">
              <div style="cursor:grab; user-select:none;">≡</div>
              <div class="fw-semibold">Упражнение</div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger js-remove-new">Удалить</button>
          </div>

          <div class="mb-2">
            {{ formset.empty_form.id }}
            <span style="display:none;">{{ formset.empty_form.DELETE }}</span>
            {{ formset.empty_form.exercise }}
          </div>

          <div class="row g-2 mb-2">
            <div class="col-6">
              <div class="small text-muted mb-1">План</div>
              {{ formset.empty_form.planned_reps }}
            </div>
            <div class="col-6">
              <div class="small text-muted mb-1">Факт</div>
              {{ formset.empty_form.actual_reps }}
            </div>
          </div>

          <div class="mb-2">
            <div class="small text-muted mb-1">Плюсы</div>
            {{ formset.empty_form.pros }}
          </div>

          <div class="mb-0">
            <div class="small text-muted mb-1">Минусы</div>
            {{ formset.empty_form.cons }}
          </div>
        </div>
      </template>

    </form>
  </div>

</div>

<script>
(function () {
  const addBtn = document.getElementById("add-row-btn");
  const statusEl = document.getElementById("reorder-status");

  const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');

  const tableBody = document.getElementById("formset-body-table");
  const cardsWrap = document.getElementById("formset-cards");

  const tplTable = document.getElementById("row-template-table");
  const tplCard = document.getElementById("row-template-card");

  function getCsrf() {
    const el = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return el ? el.value : "";
  }

  function setStatus(text) {
    if (!statusEl) return;
    statusEl.textContent = text || "";
  }

  function isMobile() {
    return window.matchMedia("(max-width: 767.98px)").matches;
  }

  // ===== FIX: disable inputs in hidden layout to avoid duplicated field names in POST =====
  function setDisabled(rootEl, disabled) {
    if (!rootEl) return;
    rootEl.querySelectorAll("input, select, textarea").forEach((el) => {
      el.disabled = disabled;
    });
  }

  function syncLayoutInputs() {
    if (isMobile()) {
      setDisabled(tableBody, true);
      setDisabled(cardsWrap, false);
    } else {
      setDisabled(cardsWrap, true);
      setDisabled(tableBody, false);
    }
  }

  // ----- add row -----
  function addRow() {
    const index = parseInt(totalForms.value, 10);

    if (isMobile()) {
      const html = tplCard.innerHTML.replaceAll("__prefix__", String(index));
      cardsWrap.insertAdjacentHTML("beforeend", html);
    } else {
      const html = tplTable.innerHTML.replaceAll("__prefix__", String(index));
      tableBody.insertAdjacentHTML("beforeend", html);
    }

    totalForms.value = index + 1;

    // новая строка должна соответствовать enabled/disabled
    syncLayoutInputs();
  }

  if (addBtn && totalForms && tplTable && tplCard && tableBody && cardsWrap) {
    addBtn.addEventListener("click", addRow);
  }

  // ----- delete saved immediately (ideal) -----
  async function deleteSaved(el, url) {
    const delInput = el.querySelector('input[type="checkbox"][name$="-DELETE"]');
    if (delInput) delInput.checked = true;

    el.style.display = "none";
    syncLayoutInputs();

    try {
      const resp = await fetch(url, {
        method: "POST",
        headers: { "X-CSRFToken": getCsrf() },
      });
      if (!resp.ok) throw new Error("bad_response");

      await persistOrder();
    } catch (e) {
      if (delInput) delInput.checked = false;
      el.style.display = "";
      syncLayoutInputs();
      window.location.reload();
    }
  }

  // ----- remove new row -----
  function removeNew(el) {
    el.remove();
    const currentTotal = parseInt(totalForms.value, 10);
    if (currentTotal > 0) totalForms.value = currentTotal - 1;
    syncLayoutInputs();
  }

  document.addEventListener("click", (e) => {
    const btnSaved = e.target.closest(".js-delete-saved");
    if (btnSaved) {
      e.preventDefault();
      const url = btnSaved.getAttribute("data-delete-url");
      if (!url) return;

      const row = btnSaved.closest("tr.formset-row") || btnSaved.closest(".formset-card");
      if (row) deleteSaved(row, url);
      return;
    }

    const btnNew = e.target.closest(".js-remove-new");
    if (btnNew) {
      e.preventDefault();
      const row = btnNew.closest("tr.formset-row") || btnNew.closest(".formset-card");
      if (row) removeNew(row);
      return;
    }
  });

  // первичная синхронизация + при смене ориентации/ширины
  syncLayoutInputs();
  window.addEventListener("resize", syncLayoutInputs);

  // ---------------- auto-fill planned reps from Exercise.default_reps (via endpoint) ----------------
  document.addEventListener("change", async (e) => {
    const select = e.target.closest(".js-exercise-select");
    if (!select) return;

    const exId = select.value;
    if (!exId) return;

    const container = select.closest("tr.formset-row") || select.closest(".formset-card");
    if (!container) return;

    const planned = container.querySelector('input[name$="-planned_reps"]');
    if (!planned) return;

    if (planned.value) return;

    try {
      const resp = await fetch(`/hattorihanzo/exercises/${exId}/default-reps/`, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!resp.ok) throw new Error("bad_response");
      const data = await resp.json();
      if (data.default_reps !== undefined && data.default_reps !== null) {
        planned.value = String(data.default_reps);
      }
    } catch (err) {
      // молча
    }
  });

  // ----- reorder -----
  let dragged = null;

  function currentSavedIds() {
    const container = isMobile() ? cardsWrap : tableBody;
    return Array.from(container.querySelectorAll("[data-ex-id]"))
      .filter(el => el.style.display !== "none")
      .map(el => el.getAttribute("data-ex-id"))
      .filter(Boolean)
      .map(x => parseInt(x, 10));
  }

  async function persistOrder() {
    const ids = currentSavedIds();
    if (ids.length < 2) return;

    setStatus("Сохраняю порядок…");

    try {
      const resp = await fetch("{% url 'hattorihanzo_exercises_reorder' session.id %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrf(),
        },
        body: JSON.stringify({ ordered_ids: ids }),
      });
      if (!resp.ok) throw new Error("bad_response");
      setStatus("Порядок сохранён");
      setTimeout(() => setStatus(""), 1200);
    } catch (e) {
      setStatus("Ошибка сохранения порядка");
      setTimeout(() => setStatus(""), 2000);
    }
  }

  function onDragStart(e) {
    const row = e.target.closest("tr.formset-row") || e.target.closest(".formset-card");
    if (!row || row.style.display === "none") return;
    dragged = row;
    row.classList.add("opacity-50");
    e.dataTransfer.effectAllowed = "move";
  }

  function onDragEnd(e) {
    const row = e.target.closest("tr.formset-row") || e.target.closest(".formset-card");
    if (row) row.classList.remove("opacity-50");
    dragged = null;
  }

  function onDragOver(e) {
    e.preventDefault();
    const container = isMobile() ? cardsWrap : tableBody;
    const target = e.target.closest("tr.formset-row") || e.target.closest(".formset-card");
    if (!container.contains(target)) return;
    if (!target || !dragged || target === dragged) return;
    if (target.style.display === "none" || dragged.style.display === "none") return;

    const rect = target.getBoundingClientRect();
    const isAfter = (e.clientY - rect.top) > rect.height / 2;

    if (isAfter) target.after(dragged);
    else target.before(dragged);
  }

  function onDrop(e) {
    e.preventDefault();
    persistOrder();
  }

  tableBody.addEventListener("dragstart", onDragStart);
  tableBody.addEventListener("dragend", onDragEnd);
  tableBody.addEventListener("dragover", onDragOver);
  tableBody.addEventListener("drop", onDrop);

  cardsWrap.addEventListener("dragstart", onDragStart);
  cardsWrap.addEventListener("dragend", onDragEnd);
  cardsWrap.addEventListener("dragover", onDragOver);
  cardsWrap.addEventListener("drop", onDrop);
})();
</script>
{% endblock %}
