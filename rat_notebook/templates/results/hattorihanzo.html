{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Дневник щенка — Hattori Hanzo</h2>

    <form method="get" class="d-flex gap-2">
      <input type="date" name="date" value="{{ selected_date|date:'Y-m-d' }}" class="form-control">
      <button class="btn btn-outline-secondary" type="submit">Показать</button>
    </form>
  </div>

  <div class="card p-3 mb-4">
    <h5 class="mb-3">Добавить тренировку</h5>

    <form method="post" id="session-create-form">
      {% csrf_token %}

      <div class="row g-3 mb-3">
        <div class="col-md-3">{{ session_form.date.label_tag }}{{ session_form.date }}</div>
        <div class="col-md-3">{{ session_form.start_time.label_tag }}{{ session_form.start_time }}</div>
        <div class="col-md-3">{{ session_form.end_time.label_tag }}{{ session_form.end_time }}</div>
        <div class="col-md-3">{{ session_form.notes.label_tag }}{{ session_form.notes }}</div>
      </div>

      {% if session_form.non_field_errors %}
        <div class="text-danger mb-2">{{ session_form.non_field_errors }}</div>
      {% endif %}

      <div class="d-flex align-items-center justify-content-between mt-3">
        <h6 class="mb-0">Упражнения</h6>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-row-btn">+ Добавить упражнение</button>
      </div>

      {{ formset.management_form }}

      {# ===================== DESKTOP TABLE ===================== #}
      <div class="table-responsive mt-2 d-none d-md-block">
        <table class="table table-sm table-striped align-middle" id="exercises-table">
          <thead>
            <tr>
              <th style="min-width:200px;">Упражнение</th>
              <th style="width:110px;">План</th>
              <th style="width:110px;">Факт</th>
              <th style="min-width:220px;">Плюсы</th>
              <th style="min-width:220px;">Минусы</th>
              <th style="width:120px;">Удалить</th>
            </tr>
          </thead>

          <tbody id="formset-body-table">
            {% for f in formset %}
              <tr class="formset-row">
                <td>
                  {{ f.id }}
                  {{ f.exercise }}
                  {% for err in f.exercise.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                </td>
                <td>
                  {{ f.planned_reps }}
                  {% for err in f.planned_reps.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                </td>
                <td>
                  {{ f.actual_reps }}
                  {% for err in f.actual_reps.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                </td>
                <td>{{ f.pros }}</td>
                <td>{{ f.cons }}</td>
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger js-remove-row">Удалить</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# ===================== MOBILE CARDS ===================== #}
      <div class="mt-2 d-block d-md-none" id="formset-cards">
        {% for f in formset %}
          <div class="card p-3 mb-2 formset-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div class="fw-semibold">Упражнение</div>
              <button type="button" class="btn btn-sm btn-outline-danger js-remove-row">Удалить</button>
            </div>

            <div class="mb-2">
              {{ f.id }}
              {{ f.exercise }}
              {% for err in f.exercise.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <div class="small text-muted mb-1">План</div>
                {{ f.planned_reps }}
                {% for err in f.planned_reps.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
              </div>
              <div class="col-6">
                <div class="small text-muted mb-1">Факт</div>
                {{ f.actual_reps }}
                {% for err in f.actual_reps.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
              </div>
            </div>

            <div class="mb-2">
              <div class="small text-muted mb-1">Плюсы</div>
              {{ f.pros }}
            </div>

            <div class="mb-0">
              <div class="small text-muted mb-1">Минусы</div>
              {{ f.cons }}
            </div>
          </div>
        {% endfor %}
      </div>

      {% if formset.non_form_errors %}
        <div class="text-danger mb-2">{{ formset.non_form_errors }}</div>
      {% endif %}

      <button class="btn btn-primary" type="submit">Сохранить тренировку</button>

      {# ======== templates for new rows (table + card), both use __prefix__ ======== #}
      <template id="row-template-table">
        <tr class="formset-row">
          <td>{{ formset.empty_form.id }}{{ formset.empty_form.exercise }}</td>
          <td>{{ formset.empty_form.planned_reps }}</td>
          <td>{{ formset.empty_form.actual_reps }}</td>
          <td>{{ formset.empty_form.pros }}</td>
          <td>{{ formset.empty_form.cons }}</td>
          <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger js-remove-row">Удалить</button>
          </td>
        </tr>
      </template>

      <template id="row-template-card">
        <div class="card p-3 mb-2 formset-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="fw-semibold">Упражнение</div>
            <button type="button" class="btn btn-sm btn-outline-danger js-remove-row">Удалить</button>
          </div>

          <div class="mb-2">
            {{ formset.empty_form.id }}
            {{ formset.empty_form.exercise }}
          </div>

          <div class="row g-2 mb-2">
            <div class="col-6">
              <div class="small text-muted mb-1">План</div>
              {{ formset.empty_form.planned_reps }}
            </div>
            <div class="col-6">
              <div class="small text-muted mb-1">Факт</div>
              {{ formset.empty_form.actual_reps }}
            </div>
          </div>

          <div class="mb-2">
            <div class="small text-muted mb-1">Плюсы</div>
            {{ formset.empty_form.pros }}
          </div>

          <div class="mb-0">
            <div class="small text-muted mb-1">Минусы</div>
            {{ formset.empty_form.cons }}
          </div>
        </div>
      </template>

    </form>
  </div>

  <h5 class="mb-2">Тренировки за {{ selected_date|date:"d.m.Y" }}</h5>

  {% for s in sessions %}
    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div class="fw-semibold">
            {{ s.start_time|time:"H:i" }} – {{ s.end_time|time:"H:i" }}
          </div>
          {% if s.notes %}
            <div class="text-muted small" style="white-space:pre-wrap;">{{ s.notes }}</div>
          {% endif %}
        </div>

        <div class="d-flex gap-2">
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'hattorihanzo_session_edit' s.id %}">Редактировать</a>
          <a class="btn btn-sm btn-outline-danger" href="{% url 'hattorihanzo_session_delete' s.id %}">Удалить</a>
        </div>
      </div>

      {# ======= DESKTOP VIEW: TABLE (как было) ======= #}
      <div class="table-responsive mt-2 d-none d-md-block">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Упражнение</th>
              <th>План</th>
              <th>Факт</th>
              <th>Плюсы</th>
              <th>Минусы</th>
            </tr>
          </thead>
          <tbody>
            {% for e in s.exercises.all %}
              <tr>
                <td class="fw-semibold">{{ e.exercise }}</td>
                <td>{{ e.planned_reps }}</td>
                <td>{{ e.actual_reps }}</td>
                <td style="white-space:pre-wrap;">{{ e.pros }}</td>
                <td style="white-space:pre-wrap;">{{ e.cons }}</td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-muted">Упражнений нет</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {# ======= MOBILE VIEW: CARDS with clamp + expand ======= #}
      <div class="mt-2 d-block d-md-none">
        {% for e in s.exercises.all %}
          <div class="card p-3 mb-2">
            <div class="fw-semibold mb-2">{{ e.exercise }}</div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <div class="small text-muted">План</div>
                <div>{{ e.planned_reps }}</div>
              </div>
              <div class="col-6">
                <div class="small text-muted">Факт</div>
                <div>{{ e.actual_reps }}</div>
              </div>
            </div>

            <div class="mb-2">
              <div class="small text-muted mb-1">Плюсы</div>
              <div class="hhz-clamp js-clamp" data-clamp-lines="3" style="white-space:pre-wrap;">{{ e.pros }}</div>
              <button type="button" class="btn btn-link btn-sm p-0 js-toggle-clamp" style="display:none;">Показать полностью</button>
            </div>

            <div class="mb-0">
              <div class="small text-muted mb-1">Минусы</div>
              <div class="hhz-clamp js-clamp" data-clamp-lines="3" style="white-space:pre-wrap;">{{ e.cons }}</div>
              <button type="button" class="btn btn-link btn-sm p-0 js-toggle-clamp" style="display:none;">Показать полностью</button>
            </div>
          </div>
        {% empty %}
          <div class="text-muted">Упражнений нет</div>
        {% endfor %}
      </div>

    </div>
  {% empty %}
    <div class="text-muted">Нет тренировок за эту дату.</div>
  {% endfor %}

</div>

<script>
(function () {
  // ---------------- create form add/remove rows ----------------
  const addBtn = document.getElementById("add-row-btn");
  const totalForms = document.querySelector('[name$="-TOTAL_FORMS"]');

  const tableBody = document.getElementById("formset-body-table");
  const cardsWrap = document.getElementById("formset-cards");

  const tplTable = document.getElementById("row-template-table");
  const tplCard = document.getElementById("row-template-card");

  function isMobile() {
    return window.matchMedia("(max-width: 767.98px)").matches;
  }

  // ===== FIX: disable inputs in hidden layout to avoid duplicated field names in POST =====
  function setDisabled(rootEl, disabled) {
    if (!rootEl) return;
    rootEl.querySelectorAll("input, select, textarea").forEach((el) => {
      el.disabled = disabled;
    });
  }

  function syncLayoutInputs() {
    // На мобиле активны cards, на десктопе активна table.
    if (isMobile()) {
      setDisabled(tableBody, true);
      setDisabled(cardsWrap, false);
    } else {
      setDisabled(cardsWrap, true);
      setDisabled(tableBody, false);
    }
  }

  function addRow() {
    const index = parseInt(totalForms.value, 10);

    if (isMobile()) {
      const html = tplCard.innerHTML.replaceAll("__prefix__", String(index));
      cardsWrap.insertAdjacentHTML("beforeend", html);
    } else {
      const html = tplTable.innerHTML.replaceAll("__prefix__", String(index));
      tableBody.insertAdjacentHTML("beforeend", html);
    }

    totalForms.value = index + 1;

    // важно: новая строка должна соответствовать текущему режиму enabled/disabled
    syncLayoutInputs();
  }

  function removeRow(btn) {
    if (isMobile()) {
      const card = btn.closest(".formset-card");
      if (!card) return;
      card.remove();
    } else {
      const tr = btn.closest("tr.formset-row");
      if (!tr) return;
      tr.remove();
    }

    const currentTotal = parseInt(totalForms.value, 10);
    if (currentTotal > 0) totalForms.value = currentTotal - 1;

    syncLayoutInputs();
  }

  if (addBtn && totalForms && tplTable && tplCard && tableBody && cardsWrap) {
    addBtn.addEventListener("click", addRow);
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".js-remove-row");
    if (btn) {
      e.preventDefault();
      removeRow(btn);
    }
  });

  // первичная синхронизация + при смене ориентации/ширины
  syncLayoutInputs();
  window.addEventListener("resize", syncLayoutInputs);

  // ---------------- auto-fill planned reps from Exercise.default_reps (via endpoint) ----------------
  document.addEventListener("change", async (e) => {
    const select = e.target.closest(".js-exercise-select");
    if (!select) return;

    const exId = select.value;
    if (!exId) return;

    const container = select.closest("tr.formset-row") || select.closest(".formset-card");
    if (!container) return;

    const planned = container.querySelector('input[name$="-planned_reps"]');
    if (!planned) return;

    // не перетираем ручной ввод
    if (planned.value) return;

    try {
      const resp = await fetch(`/hattorihanzo/exercises/${exId}/default-reps/`, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      });
      if (!resp.ok) throw new Error("bad_response");
      const data = await resp.json();
      if (data.default_reps !== undefined && data.default_reps !== null) {
        planned.value = String(data.default_reps);
      }
    } catch (err) {
      // молча
    }
  });

  // ---------------- mobile clamp expand/collapse (pros/cons) ----------------
  function applyClamp(el, lines) {
    el.style.setProperty("--hhz-lines", String(lines));
    el.classList.add("hhz-clamp");
  }

  function isOverflowing(el) {
    const was = el.classList.contains("hhz-expanded");

    el.classList.remove("hhz-expanded");
    const clampedH = el.getBoundingClientRect().height;

    el.classList.add("hhz-expanded");
    const fullH = el.getBoundingClientRect().height;

    if (!was) el.classList.remove("hhz-expanded"); else el.classList.add("hhz-expanded");

    return fullH > clampedH + 1;
  }

  function initClampBlocks() {
    const blocks = document.querySelectorAll(".js-clamp");
    blocks.forEach((block) => {
      const lines = parseInt(block.getAttribute("data-clamp-lines") || "3", 10);
      applyClamp(block, lines);

      const btn = block.parentElement.querySelector(".js-toggle-clamp");
      if (!btn) return;

      if (!block.textContent || block.textContent.trim().length === 0) {
        btn.style.display = "none";
        return;
      }

      if (isOverflowing(block)) {
        btn.style.display = "inline-block";
        btn.textContent = "Показать полностью";
      } else {
        btn.style.display = "none";
      }
    });
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".js-toggle-clamp");
    if (!btn) return;

    e.preventDefault();
    const block = btn.parentElement.querySelector(".js-clamp");
    if (!block) return;

    const expanded = block.classList.toggle("hhz-expanded");
    btn.textContent = expanded ? "Свернуть" : "Показать полностью";
  });

  initClampBlocks();

  window.addEventListener("resize", () => {
    initClampBlocks();
  });
})();
</script>
{% endblock %}
