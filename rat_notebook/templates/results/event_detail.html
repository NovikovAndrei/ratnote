{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <a href="{% url 'event_list' %}" class="btn btn-outline-light mb-3">‚Üê –í—Å–µ —Å–æ–±—ã—Ç–∏—è</a>
  <h1 class="mb-4">{{ event.name }} ‚Äî {{ event.date }}</h1>

  <div class="row g-4 mb-5">
    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞ -->
    <div class="col-md-6">
      <div class="card p-4">
        <h3 class="mb-4">–î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞</h3>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="add_athlete" value="1">
          {{ athlete_form.non_field_errors }}
          <div class="mb-3">
            {{ athlete_form.name.label_tag }} {{ athlete_form.name }}
            {% for err in athlete_form.name.errors %}
              <div class="text-danger">{{ err }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            {{ athlete_form.growth_category.label_tag }} {{ athlete_form.growth_category }}
            {% for err in athlete_form.growth_category.errors %}
              <div class="text-danger">{{ err }}</div>
            {% endfor %}
          </div>
          <div class="form-check mb-3">
            {{ athlete_form.is_champion }} {{ athlete_form.is_champion.label_tag }}
            {% for err in athlete_form.is_champion.errors %}
              <div class="text-danger">{{ err }}</div>
            {% endfor %}
          </div>
          <button class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞</button>
        </form>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div class="col-md-6">
      <div class="card p-4">
        <h3 class="mb-4">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h3>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="add_result" value="1">

          {% if result_form.non_field_errors %}
            <div class="alert alert-danger">
              {% for e in result_form.non_field_errors %}
                <div>{{ e }}</div>
              {% endfor %}
            </div>
          {% endif %}

          <div class="mb-3">
            <label for="athleteSelect" class="form-label">{{ result_form.athlete.label }}</label>
            <select id="athleteSelect"
                    name="{{ result_form.athlete.html_name }}"
                    class="form-select">
              <option value="">---------</option>
              {% for ath in result_form.fields.athlete.queryset %}
                <option value="{{ ath.pk }}"
                        data-category="{{ ath.growth_category }}"
                        data-champion="{{ ath.is_champion|yesno:'true,false' }}">
                  {{ ath.name }} ({{ ath.growth_category }}){% if ath.is_champion %} üèÜ{% endif %}
                </option>
              {% endfor %}
            </select>
            {% for err in result_form.athlete.errors %}
              <div class="text-danger">{{ err }}</div>
            {% endfor %}
          </div>

          <div class="mb-3">
            {{ result_form.discipline.label_tag }} {{ result_form.discipline }}
            {% for err in result_form.discipline.errors %}
              <div class="text-danger">{{ err }}</div>
            {% endfor %}
          </div>
          <div class="mb-3">
            {{ result_form.result.label_tag }} {{ result_form.result }}
            {% for err in result_form.result.errors %}
              <div class="text-danger">{{ err }}</div>
            {% endfor %}
          </div>
          <button class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
        </form>
      </div>
    </div>
  </div>

  <!-- –í–∫–ª–∞–¥–∫–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
  <ul class="nav nav-tabs" id="catTabs" role="tablist">
    {% for cat_code, data in category_rankings.items %}
      {% with label=data.0 %}
      <li class="nav-item" role="presentation">
        <button
          class="nav-link {% if active_group == cat_code %}active{% endif %}"
          id="tab-{{ cat_code }}"
          data-bs-toggle="tab"
          data-bs-target="#pane-{{ cat_code }}"
          type="button"
          role="tab"
          aria-controls="pane-{{ cat_code }}"
          aria-selected="{% if active_group == cat_code %}true{% else %}false{% endif %}"
        >{{ label }}</button>
      </li>
      {% endwith %}
    {% endfor %}
  </ul>

  <div class="tab-content mt-3" id="catTabsContent">
    {% for cat_code, data in category_rankings.items %}
      {% with label=data.0 athletes_list=data.1 %}
      <div
        class="tab-pane fade {% if active_group == cat_code %}show active{% endif %}"
        id="pane-{{ cat_code }}"
        role="tabpanel"
        aria-labelledby="tab-{{ cat_code }}"
      >
        <div class="card p-3 mb-4">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th>–ú–µ—Å—Ç–æ</th>
                <th>–°–ø–æ—Ä—Ç—Å–º–µ–Ω</th>
                <th>–û—á–∫–∏</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody>
              {% for athlete in athletes_list %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ athlete.name }}</td>
                  <td>{{ athlete.total_points|floatformat:0 }}</td>
                  <td></td>
                </tr>
                <tr class="table-secondary">
                  <td colspan="4">
                    <strong>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</strong>
                    <table class="table table-sm mt-2 mb-0">
                      <thead>
                        <tr>
                          <th>–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</th>
                          <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                          <th>–û—á–∫–∏</th>
                          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for res in athlete.results.all %}
                          <tr>
                            <td>{{ res.discipline.verbose }}</td>
                            <td>
                              {% if res.discipline.code == 'treadmill' %}
                                {{ res.result|floatformat:2 }}
                              {% else %}
                                {{ res.result|floatformat:0 }}
                              {% endif %}
                            </td>
                            <td>{{ res.points|floatformat:0 }}</td>
                            <td>
                              <a href="{% url 'edit_result' event.id res.id %}?group={{ cat_code }}" class="btn btn-sm btn-outline-secondary">–†–µ–¥.</a>
                              <a href="{% url 'delete_result' event.id res.id %}?group={{ cat_code }}" class="btn btn-sm btn-outline-danger">–£–¥–∞–ª.</a>
                            </td>
                          </tr>
                        {% empty %}
                          <tr><td colspan="4">–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</td></tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="4">–ù–µ—Ç —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–æ–≤</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endwith %}
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const select = document.getElementById('athleteSelect');
  if (!select) return;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –æ–ø—Ü–∏–∏ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π "---------")
  const allOpts = Array.from(select.options).slice(1);

  function filter(cat) {
    // –û—á–∏—Å—Ç–∏—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
    select.innerHTML = '';
    select.append(new Option('---------', ''));

    allOpts.forEach(opt => {
      const oCat = opt.dataset.category;
      const champ = (opt.dataset.champion === 'true');
      if (cat === 'C') {
        if (champ) select.append(opt.cloneNode(true));
      } else {
        if (!champ && oCat === cat) select.append(opt.cloneNode(true));
      }
    });
  }

  // –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ‚Äî –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
  const activeBtn = document.querySelector('#catTabs button.active');
  if (activeBtn) filter(activeBtn.id.replace('tab-', ''));

  // –ò –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–∞–±–∞
  document.querySelectorAll('#catTabs button').forEach(btn => {
    btn.addEventListener('shown.bs.tab', e => {
      filter(e.target.id.replace('tab-', ''));
      // –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–∫–∏
      select.value = '';
    });
  });
});
</script>
{% endblock %}
